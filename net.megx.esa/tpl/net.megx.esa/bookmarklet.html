<!doctype html>
<head>
<base href="$ctx.siteUrl/net.megx.esa/bookmarklet.html">
<meta charset="utf-8">
<title>Bookmarklet</title>

<link rel="stylesheet"
	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/smoothness/jquery-ui.css">
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.js"></script>
<script
	src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.js">></script>


<style type="text/css">
input[type="text"] {
	height: 12px;
}

textarea {
	height: 30px;
}
</style>

</head>
<body bgcolor="white" style="font-size: small;">

	<img src="$ctx.siteUrl/images/logo.png"
		style="padding-left: 35px; padding-top: 10px"> #if($req.user)

	<script type="text/javascript">
		var curent = 1;
		var allSamples = 1;
		var curentAuthor = 1;
		var allAurhors = 1;

		$(document).ready(function() {
			$("#next_button").hide();
			$("#back_button").hide();
			$("#next_button_aurhor").hide();
			$("#back_button_aurhor").hide();
			setDateTime("");
		});


		function setDateTime(id){
			var currentdate = new Date();
			$("#time"+id).val(currentdate.getHours()+":"+currentdate.getMinutes()+":"+currentdate.getSeconds());
			$("#date"+id).val((currentdate.getMonth()+1)  + "/" + currentdate.getDate() + "/"  + currentdate.getFullYear());
			$("#date"+id).datepicker();
		}	

		
		 
		function getSampleHtml(allSamples){
			var divv = "<div id='sample"+allSamples+"'><table><tr>"
			+ "<td>Sample name</td>"
			+ "<td><input type='text' id='label'></td>" + "</tr><tr>"
			+ "<td>Region name</td>"
			+ "<td><select id='region'>"
			+ "<option value='b'>Bitola</option>"
			+ "<option value='s'>Skopje</option>"
			+ "<option value='p'>Prilep</option>"
			+ "</select></td></tr><tr>"
			+ "<td>Habitat</td>"
			+ "<td><select id='habitat'>"
			+ "<option value='b'>Habitat</option>"
			+ "<option value='s'>Habitat1</option>"
			+ "<option value='p'>Habitat2</option>"
			+ "</select></td></tr><tr>"
			+ "<td>Longitude</td>"
			+ "<td><input type='text' id='longitude'></td>"
			+ "</tr><tr>" + "<td>Latitude</td>"
			+ "<td><input type='text' id='latitude'></td>"
			+ "</tr><tr>" + "<td>Material</td>"
			+ "<td><input type='text' id='material'></td>"
			+ "</tr><tr>" + "<td>Depth</td>"
			+ "<td><input type='text' id='depth'></td>" + "</tr><tr>"
			+ "<td>Sample Date</td>"
			+ "<td><input type='text' id='date"+allSamples+"'></td>" + "</tr><tr>"
			+ "<td>Sample Time</td>"
			+ "<td><input type='text' id='time"+allSamples+"'></td>" + "</tr><tr>"
			+ "<td>sequence accession<br/> number</td>"
			+ "<td><input type='text' id='san'></td>"
			+ "</tr></table></div>";

			return divv;
		}
		
		function getAllAuthores(){
			forename = $('[id^="forename"]');    
			initials = $('[id^="initials"]'); 
			surename = $('[id^="surename"]'); 
			position = $('[id^="position"]'); 
			var objArr = [];
			
			for(i=0;i<forename.length;i++){
				var obj = {
					forename : forename[i].value,
					initials : initials[i].value,
					surename : surename[i].value,
					position : position[i].value
				}
				objArr.push(obj);
			}
			return objArr;
		}
		
		function getAllSamples(){
			label = $('[id^="label"]');    
			region = $('[id^="region"]'); 
			longitude = $('[id^="longitude"]'); 
			latitude = $('[id^="latitude"]'); 
			material = $('[id^="material"]'); 
			depth = $('[id^="depth"]'); 
			date = $('[id^="date"]'); 
			time = $('[id^="time"]'); 

			var objArr = [];
			
			for(i=0;i<region.length;i++){
				var temp = date[i].value.split("-");
				var tempTime = time[i].value.split(":");
				var obj = {
					label : label[i].value,
					region : region[i].value,
					longitude : longitude[i].value,
					latitude : latitude[i].value,
					material : material[i].value,
					depth : depth[i].value,
					//depthunit : $('#doi').val(),
					samyear : temp[0],
					sammonth : temp[1],
					samday : temp[2],
					samhour : tempTime[0],
					sammin : tempTime[1],
					samsec : tempTime[2]
				}
				objArr.push(obj);
			}
			return objArr;
		}
		
		
			
		function getAuthorHtml(allSamples){
			var divAuthors = "<div id='aurhor"+allAurhors+"'><table><tr>"
			+ "<td width='109px'>Forename</td>"
			+ "<td><input type='text' id='forename'></td>" + "</tr><tr>"
			+ "<td>Initials</td>"
			+ "<td><input type='text' id='initials'></td>"
			+ "</tr><tr>" + "<td>Surename</td>"
			+ "<td><input type='text' id='surename'></td>"
			+ "</tr><tr>" + "<td>Position</td>"
			+ "<td><input type='text' id='position"+allAurhors+"'></td>"
			+ "</tr></table></div>";
			
			return divAuthors;
		}

		function add(id) {
			if(id == "sample"){
				$("#sample" + curent).hide();
				allSamples++;
				curent = allSamples;
				$("#samples").append(getSampleHtml(allSamples));
				$("#next_button").hide();
				if (!($("#back_button").is(":visible"))) {
					$("#back_button").show();
				}
				$("#curentSample").html("Curent sample :" + curent);
				setDateTime(curent);
			}else{
				$("#aurhor" + curentAuthor).hide();
				allAurhors++;
				curentAuthor = allAurhors;
				$("#authors").append(getAuthorHtml(allAurhors));
				$("#next_button_aurhor").hide();
				if (!($("#back_button_aurhor").is(":visible"))) {
					$("#back_button_aurhor").show();
				}
				$("#curentAurhor").html("Curent aurhor :" + curentAuthor);
				$("#position"+curentAuthor).val(curentAuthor);
			}
		}

		function previous(id) {
			if(id == "sample"){
				$("#sample" + curent).hide();
				curent--;
				$("#sample" + (curent)).show();

				if (curent < allSamples) {
					$("#next_button").show();
				}
				if (curent == 1) {
					$("#back_button").hide();
				}
				$("#curentSample").html("Curent sample :" + curent);
			}else{
				$("#aurhor" + curentAuthor).hide();
				curentAuthor--;
				$("#aurhor" + (curentAuthor)).show();

				if (curentAuthor < allAurhors) {
					$("#next_button_aurhor").show();
				}
				if (curentAuthor == 1) {
					$("#back_button_aurhor").hide();
				}
				$("#curentAurhor").html("Curent aurhor :" + curentAuthor);
			}
		}

		function next(id) {
			if(id == "sample"){
				$("#sample" + curent).hide();
				curent++;
				$("#sample" + curent).show();

				if (curent == allSamples) {
					$("#next_button").hide();
				}

				if (!($("#back_button").is(":visible"))) {
					$("#back_button").show();
				}
				$("#curentSample").html("Curent sample :" + curent);
			}else{
				$("#aurhor" + curentAuthor).hide();
				curentAuthor++;
				$("#aurhor" + curentAuthor).show();

				if (curentAuthor == allAurhors) {
					$("#next_button_aurhor").hide();
				}

				if (!($("#back_button_aurhor").is(":visible"))) {
					$("#back_button_aurhor").show();
				}
				$("#curentAurhor").html("Curent aurhor :" + curentAuthor);
			}
		}
		
		function testSer() {

			$.ajax({
				contentType : 'application/json',
				data : JSON.stringify(collectData()),
				dataType : 'json',
				success : function(data) {
					alert("S");
				},
				error : function(a, b, c) {
					alert("E");
				},
				//processData : false,
				type : 'POST',
				url : "${ctx.siteUrl}" + '/ws/pubmap/article/add'
			});
		}

		function collectData() {
			var json = {
				authors : getAllAuthores(),
				title : $('#title').val(),
				website : $('#url').val(),
				abstractUrl : $('#abstractUrl').val(),
				year : $('#publicationDate').val(),
				journalArticle : {
					issue : $('#issue').val(),
					//	isoab : $('#publicationDate').val(),
					pages : $('#pages').val(),
					publication : $('#journalName').val(),
					//	volume : $('#publicationDate').val(),
					month : $('#publicationDate').val(),
					day : $('#publicationDate').val(),
					abstractText : $('#abstractText').val(),
				//	eissn : $('#publicationDate').val(),
				//	pissn : $('#publicationDate').val()
				},
				identifiers : {
					doi : $('#doi').val(),
					pmid : $('#pubmedId').val()
				},
				samples : getAllSamples(),
				abstractUrl : $('#abstractUrl').val(),
				institute : $('#institute').val()
			};
			
			
			return json;
		};
	</script>
	<table>
		<tr><td>
			<table>
				<tr>
					<td width="50"><input id="back_button_aurhor" type="image"
						onclick="previous('aurhor')"
						src="$ctx.siteUrl/images/icons/blue-document-page-previous.png"
						width="20" height="20"></td>
					<td width="50"><input id="next_button_aurhor" type="image"
						onclick="next('aurhor')"
						src="$ctx.siteUrl/images/icons/blue-document-page-next.png"
						width="20" height="20"></td>
					<td width="50"><input id="add_button_aurhor" type="button"
						onclick="add('aurhor')"
						value="Add author"></td>
					<td><div id="curentAurhor"></div></td>
				</tr>
			</table>
		</td></tr>
		<tr><td>
			<div id="authors">
				<div id="aurhor1">
					<table>
						<tr>
							<td width="109px">Forename</td>
							<td><input type="text" id="forename"></td>
						</tr>
						<tr>
							<td>Initials</td>
							<td><input type="text" id="initials"></td>
						</tr>
						<tr>
							<td>Surename</td>
							<td><input type="text" id="surename"></td>
						</tr>
						<tr>
							<td>Position</td>
							<td><input type="text" id="position" value="1"></td>
						</tr>
					</table>
				</div>
			</div></td>
		</tr>
		<tr><td>
			<table>
				<tr>
					<td width="108">Title</td>
					<td><input type="text" id="title"></td>
				</tr>
				<tr>
					<td>URL</td>
					<td><input type="text" id="url"></td>
				</tr>
				<tr>
					<td>Abstract URL</td>
					<td><input type="text" id="abstractUrl"></td>
				</tr>
				<tr>
					<td>Publication Date</td>
					<td><input type="text" id="publicationDate"></td>
				</tr>
				<tr>
					<td>DOI</td>
					<td><input type="text" id="doi"></td>
				</tr>
				<tr>
					<td>Issue</td>
					<td><input type="text" id="issue"></td>
				</tr>
				<tr>
					<td>Journal name</td>
					<td><input type="text" id="journalName"></td>
				</tr>
				<tr>
					<td>Pages</td>
					<td><input type="text" id="pages"></td>
				</tr>
				<tr>
					<td>Kind of publication</td>
					<td><input type="text" id="publicationType"></td>
				</tr>
				<tr>
					<td>PubMed ID</td>
					<td><input type="text" id="pubmedId"></td>
				</tr>
				<tr>
					<td>Institute</td>
					<td><input type="text" id="institute"></td>
				</tr>
				<tr>
					<td>Abstract text</td>
					<td><textarea type="text" id="abstractText"></textarea></td>
				</tr>
				<tr>
					<td>ISSN</td>
					<td><input type="text" id="issn"></td>
				</tr>
				<tr>
					<td>ISO abbreviation</td>
					<td><input type="text" id="iso"></td>
				</tr>
			</table></td>
		</tr>
		<tr><td>
			<table>
				<tr>
					<td width="50"><input id="back_button" type="image"
						onclick="previous('sample')"
						src="$ctx.siteUrl/images/icons/blue-document-page-previous.png"
						width="20" height="20"></td>
					<td width="50"><input id="next_button" type="image"
						onclick="next('sample')"
						src="$ctx.siteUrl/images/icons/blue-document-page-next.png"
						width="20" height="20"></td>
					<td width="50"><input id="add_button" type="button"
						onclick="add('sample')"
						value="Add Sample"></td>
					<td><div id="curentSample"></div></td>
				</tr>
			</table></td>
		</tr>

		<tr><td>
			<div id="samples">
				<div id="sample1">
					<table>
						<tr>
							<td>Sample name</td>
							<td><input type="text" id="label"></td>
						</tr>
						<tr>
							<td>Region name</td>
							<td><select id="region">
									<option value="b">Bitola</option>
									<option value="s">Skopje</option>
									<option value="p">Prilep</option>
							</select></td>
						</tr>
						<tr>
							<td>Habitat</td>
							<td><select id="habitat">
									<option value="b">Habitat</option>
									<option value="s">Habitat1</option>
									<option value="p">Habitat2</option>
							</select></td>
						</tr>
						<tr>
							<td>Longitude</td>
							<td><input type="text" id="longitude"></td>
						</tr>
						<tr>
							<td>Latitude</td>
							<td><input type="text" id="latitude"></td>
						</tr>
						<tr>
							<td>Material</td>
							<td><input type="text" id="material"></td>
						</tr>
						<tr>
							<td>Depth</td>
							<td><input type="text" id="depth"></td>
						</tr>
						<tr>
							<td>Sample Date</td>
							<td><input type="text" id="date"></td>
						</tr>
						<tr>
							<td>Sample Time</td>
							<td><input type="text" id="time"></td>
						</tr>
						<tr>
							<td>sequence accession<br /> number
							</td>
							<td><input type="text" id="san"></td>
						</tr>
					</table>
				</div>
			</div></td>
		</tr>
		<tr><td align="right">
				<input id="next_button" type="button" onclick="testSer()"
						value="Submit" ></td>
		</tr>
	</table>

	#else
	<script type="text/javascript">
		function changeLoginCheck() {
			var change = "<a href='$ctx.siteUrl/bookmark' onclick='changeLoginCheck()' style='border: 2px solid #002638; padding: 10px 40px; background: #00A3EF; border-radius: 25px;'>Refresh</a>";
			$("#loginCheck").html(change);
			$("#loginCheck").css("padding-left" , "95px")
		}
	</script>
	<div id="loginCheck" style="padding-left: 55px;">
		<a href="$ctx.siteUrl/login"
			style="border: 2px solid #002638; padding: 10px 40px; background: #00A3EF; border-radius: 25px;"
			target="_blank" onclick="changeLoginCheck()">Log in to megx.com</a>
	</div>

	#end
</body>
</html>
