<style>
.registration-wrapper {
	padding: 15px;
}

.registraton-field-label {
	width: 150px;
}

.input-wrapper {
	margin: 5px;
}

.register-action {
	float: left;
	width: 90px;
	margin: 10px;
}

.required {
	color: #800;
}

.notification-entry {
	padding: 10px;
	/*background: #AAA;*/
	color: #A00;
}

.invalid {
	background: #FDD;
}

@media ( max-width : 980px) {
	article.header-right {
		width: auto;
	}
	div.input-wrapper {
		margin: 0px;
	}
	.registration-wrapper {
		width: auto;
	}
	input[type='text'],input[type='password'] {
		width: 80%;
	}
	#wrapper {
		box-shadow: none;
		width: 100%;
	}
	header nav ul {
		display: none;
	}
	div.headerBorder {
		display: none;
	}
	header nav {
		width: 100%;
	}
	.copy,.footNav,footer {
		width: auto;
		display: inline-block;
	}
	footer {
		background-image: none;
	}
	header {
		width: auto;
	}
	header,body {
		min-width: 100%;
	}
	body {
		width: 100%;
	}
}

@media ( max-width : 655px) {
	form {
		width: 100%;
	}
	header,body {
		min-width: 100%;
	}
	body {
		width: 100%;
	}
	header {
		width: auto;
	}
	.copy,.footNav {
		width: 100%;
	}
	div.headerBorder {
		display: none;
	}
}

@media ( max-width : 535px) {
	footer section ul {
		width: 98%;
		float: none;
	}
	footer section ul li,footer section.footNav ul {
		width: 98%;
		display: inline-block;
		float: none;
		text-align: center;
	}
	article.header-right { /* login button*/
		float: none;
		display: none;
	}
	#recaptcha_widget_wrapper {
		margin-left: 0px;
		padding-left: 0px;
	}
	#recaptcha_area {
		margin-left: -17px;
		padding-left: 0px;
	}
}
</style>
<script type="text/javascript"
	src="http://www.google.com/recaptcha/api/js/recaptcha_ajax.js"></script>

<script type="text/javascript">
	$(document).ready(function(){
		$('#btn-cancel').click(function(){
			window.location='$ctx.siteUrl/';
		});
		
		var N = {
				notify: function(){
					var m = [];
					for (var  i = 0; i < arguments.length; i++){
						m.push([
							'<div class="notification-entry">', 
								arguments[i].toString(),
							'</div>'
						].join(''));
					}
					$('.notifications').append(m.join(''));
				},
				clear:function(){
					$('.notifications').html('');
				}
		};
		
		var loadReCaptcha = function(){
			// re-captcha widget
			Recaptcha.create("$ext.securityFilter.reCaptchaPublicKey",
				"recaptcha_widget_wrapper",
				{
					theme: "red",
					callback: Recaptcha.focus_response_field
				}
			);
		};
		
		
		$('#btn-register').click(function(){
			N.clear();
			$('input').removeClass('invalid');
			var valid = true;
			var pass = $("input[name='pass']").val() || '';
			var rePass = $("input[name='rePass']").val() || '';
			var firstName = $.trim($("input[name='firstName']").val() || '');
			var lastName = $.trim($("input[name='lastName']").val() || '');
			var initials = $.trim($("input[name='initials']").val() || '');
			
			if($.trim(pass) != $.trim(rePass)){
				N.notify('Password must match!');
				return;
			}
			
			
			var required = {
			   'logname': 'Please enter the username.',
			   'email': 'Please enter the email.',
			   'pass': 'Please enter the password.'
			};
			
			for (var sel in required){
				if(required.hasOwnProperty(sel)){
					var val = $.trim($("input[name='"+sel+"']").val() || '');
					if(val == ''){
						N.notify(required[sel]);
						$("input[name='"+sel+"']").addClass('invalid');
						valid=false;
					}
					else if(sel == 'logname'){
						if(!/^[a-zA-Z0-9_\\.\\-]+$/.test(val)){
							N.notify("Please enter valid username. The username can be any combination of letters, numbers, underscore dot or a dash.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
						else if(val.length < 3 || val.length > 20){
							N.notify("The length of the username must be between 3 and 20 characters long.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
					else if(sel == 'email'){
						if(!(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(val))){
							N.notify("Please enter valid email.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
					else if(sel == 'pass'){
						if(val.length < 3 || val.length > 20){
							N.notify("The length of the password must be between 3 and 20 characters long.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
				}
			}
			
			if(firstName != ''){
				if(firstName.length < 3 || firstName.length > 20){
	     		   	N.notify("The length of the first name must be between 3 and 20 characters long.");
	     		   	$("input[name='firstName']").addClass('invalid');
	     		   	return false;
	     	   	}
				else if(!/^[a-zA-Z]+$/.test(firstName)){
	   		  		N.notify("Please enter valid first name. The first name can be any combination of letters.");
	   		  		$("input[name='firstName']").addClass('invalid');
	    		  	return false;
	     	   	}
			}
			
			if(lastName != ''){
				if(lastName.length < 3 || lastName.length > 30){
	     		   	N.notify("The length of the last name must be between 3 and 30 characters long.");
	     		   	$("input[name='lastName']").addClass('invalid');
	     		   	return false;
	     	   	}
				else if(!/^[a-zA-Z]+$/.test(lastName)){
	   		  		N.notify("Please enter valid last name. The last name can be any combination of letters.");
	   		  		$("input[name='lastName']").addClass('invalid');
	    		  	return false;
	     	   	}
			}
			
			if(initials != ''){
				if(initials.length < 1 || initials.length > 5){
	     		   	N.notify("The length of the initials string must be between 1 and 5 characters long.");
	     		   	$("input[name='initials']").addClass('invalid');
	     		   	return false;
	     	   	}
				else if(!/^[a-zA-Z]+$/.test(initials)){
	   		  		N.notify("Please enter valid initials string. The initials can be any combination of letters.");
	   		  		$("input[name='initials']").addClass('invalid');
	    		  	return false;
	     	   	}
			}
			
			if (!valid) {
				return;
			}
			
			$.ajax({
				url:'$ctx.siteUrl/ws/register',
				type: 'POST',
				dataType: 'json',
				data: {
					logname: $('input[name=logname]').val(),
					firstName: $('input[name=firstName]').val(),
					lastName: $('input[name=lastName]').val(),
					initials: $('input[name=initials]').val(),
					email: $('input[name=email]').val(),
					challenge: Recaptcha.get_challenge(),
					response: Recaptcha.get_response(),
					pass: pass
				},
				 statusCode: {
					200: function() {
					  N.clear();
					  N.notify( "Thanks :) You have successfully registered." );
					  window.location = '$ctx.siteUrl/login';
					}
				},
				
				error: function(xhr, textStatus, errorThrown) {
					N.notify(xhr.responseText);
					N.notify( "Something went wrong." );
				}
			});
			//Recaptcha.destroy();
		});
		
		loadReCaptcha();
		
		
	});
</script>

<div class="registration-wrapper">
	<p>Please fill in the following form to create your own account.</p>
	<p>
		Fields with <span class="required">*</span> are required.
	</p>
	<div class="notifications"></div>
	<form id="register-form" method="post"
		action="$ctx.siteUrl/register/doRegistration">
		<div class="input-wrapper">
			<label class="registraton-field-label">Username:<span
				class="required">*</span></label> <input type="text" name="logname">
		</div>
		<div class="input-wrapper">
			<label class="registraton-field-label">e-mail:<span
				class="required">*</span></label> <input type="text" name="email">
		</div>

		<div class="input-wrapper">
			<label class="registraton-field-label">Password:<span
				class="required">*</span></label> <input type="password" name="pass">
			<label class="registraton-field-label">Repeat Password:<span
				class="required">*</span></label> <input type="password" name="rePass">
		</div>

		<div class="input-wrapper">
			<label class="registraton-field-label">First Name:</label> <input
				type="text" name="firstName">
		</div>

		<div class="input-wrapper">
			<label class="registraton-field-label">Last Name:</label> <input
				type="text" name="lastName">
		</div>

		<div class="input-wrapper">
			<label class="registraton-field-label">Initials:</label> <input
				type="text" name="initials">
		</div>

		<div id="recaptcha_widget_wrapper"></div>


		<div>
			<input type="button" value="Register" class="register-action"
				id="btn-register"> 
			<input type="button" value="Cancel"
				class="register-action" id="btn-cancel">
		</div>
	</form>
</div>