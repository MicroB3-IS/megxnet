<script type="text/javascript"
	src="$ctx.siteUrl/net.megx.form-widget/js/alpaca-full-1.1.3.min.js"></script>
<script type="text/javascript"
	src="$ctx.siteUrl/net.megx.form-widget/js/megx-form-widget-0.1.js"></script>
<link href="$ctx.siteUrl/net.megx.form-widget/css/alpaca-1.1.3.css"
	rel="stylesheet" type="text/css">
<link href="$ctx.siteUrl/net.megx.osd.registry/stylesheets/osdRegistry.css" rel="stylesheet" type="text/css">

<div id="errorMsg"></div>
<div id="participationForm" style="padding: 15px"></div>

<script type="text/javascript">
#if(($req.user && !$req.user.empty) && ($req.servletRequset.session.getAttribute("userEmail")))
	user = '$req.user.name';
	email = '$req.servletRequset.session.getAttribute("userEmail")';
#else
	user = null;
    email = null;
#end

var MegxFormWidget = new MegxFormWidget({
    target: "participationForm",
    errorTarget : "errorMsg",
    schemaLocation: ctx.siteUrl + "/net.megx.osd.registry/data/participation-schema.json",
    optionsLocation: ctx.siteUrl + "/net.megx.osd.registry/data/participation-options.json",
    formId: "participation-form",
    postRender: function(field) {

        var form = field.form;
        var fieldSet = form.field[0];
        var url = form.attributes.action;
        var ajaxMethod = form.attributes.method;
        
        var errorElement = jQuery('#' + MegxFormWidget.cfg.errorTarget);
		
        if (user != null && email != null) {

            var contactName = field.childrenByPropertyId["contactName"];
            contactName.setValue(user);
            var contactEmail = field.childrenByPropertyId["contactEmail"];
            contactEmail.setValue(email);

            
            var contactNameInput = fieldSet[1];
            contactNameInput.readOnly = true;

            var contactEmailInput = fieldSet[2];
            contactEmailInput.readOnly = true;
            
            if (form) {

                form.registerSubmitHandler(function(e, form) {
                    return false;
                });

                form.buttons.submit.click(function() {
                	
                	form.disableSubmitButton();

                	if (field.isValid(true)) {

                        var data = field.getValue();
                        data.json = JSON.stringify(field.getValue());
                        jQuery.ajax({
                            type: ajaxMethod,
                            url: url,
                            data: data,
                            success: function(data, textStatus, jqXHR) {
                            	
                            	if(data.redirectUrl && data.redirectUrl != ""){
                            		alert("Your submission was successfull. Thanks!");
                            		document.location.href = data.redirectUrl;
                            	} else {
                            		
                            		if(data.message && data.message != ""){
                            			alert(data.message);
                            			document.location.href = ctx.siteUrl;
                            		} else{
                            			alert("Your submission was successfull. Thanks!");
                                		document.location.href = ctx.siteUrl;
                            		}
                            	}
                            },
                            error: function(data, textStatus, jqXHR) {

                            	form.enableSubmitButton();
                            	
                            	if(data.responseJSON && data.responseJSON != ""){
                            		
                            		var responseMsg = data.responseJSON;
                                	
                                	if(responseMsg.redirectUrl && responseMsg.redirectUrl != ""){
                                		document.location.href = responseMsg.redirectUrl;
                                	} else {
                                		
                                		if(responseMsg.message && responseMsg.message != ""){
                                			errorElement.text(responseMsg.message).show();
                                		} else{
                                			errorElement.text("Server error, please try again later.").show();
                                		}
                                	}
                            		
                            	} else {
                            		errorElement.text("Server error, please try again later.").show();
                            	}
                            }
                        });
                    }
                });
            }

        } else {
        	errorElement.text("You need to be logged in, in case you don't have user you can use this form name and mail to create one.").show();
        	var userName = field.childrenByPropertyId["contactName"];
        	var userMail = field.childrenByPropertyId["contactEmail"];
        	
        	form.registerSubmitHandler(function(e, form) {
        		return false;
        	});
        	form.buttons.submit.click(function() {
        	    if (confirm("Do you want to use your entered name and email to create megx.net user in order to submit participation?!") == true) {
        	    	document.location.href = "$ctx.siteUrl/register?userName="+userName.getValue()+"&userMail="+userMail.getValue();
        	    } 
        	});
           	
        }

    }
});
 
</script>
