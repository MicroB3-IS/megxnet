<script type="text/javascript" src="$ctx.siteUrl/js/mustache.js"></script>

#include("pages/blast/css.html")	
#set( $job = $ext.blast.getBlastJob($jobId) )

<div id="blast_ct">
	<div class="panel_ct">
		<div class="title">Job Summary</div>
		<div style="clear: both"></div>
		<div class="panelContent">
		<table style="width: 100%">
			<tr>
				<td class="label">Job Id</td>
				<td class="value">$job.jobId</td>
				<td class="label">Submitted</td>
				<td class="value">$ext.utils.formatDate($job.submitted, "MM/dd/yyyy")</td>
				<td class="label">Query Sequence</td>
				<td class="value"><a href="#">$job.querySequence</a></td>
			</tr>
			<tr>
				<td class="label">Job Name</td>
				<td class="value">$job.jobName</td>
				<td class="label">Program</td>
				<td class="value">$job.program</td>
				<td class="label">Subject Sequence</td>
				<td class="value">$job.subjectSequence</td>
			</tr>
			<tr>
				<td class="label">Status</td>
				<td class="value $job.statusColor">$job.status</td>
				<td class="label"># Hits</td>
				<td class="value">$job.hits</td>
				<td class="label">&nbsp;</td>
				<td class="value">&nbsp;</td>
			</tr>
			<tr>
				<td class="label">Job Parementers</td>
				<td class="value green"><a href="#">view</a></td>
				<td class="label">&nbsp;</td>
				<td class="value">&nbsp;</td>
				<td class="label">&nbsp;</td>
				<td class="value">&nbsp;</td>
			</tr>
		</table>
		</div>
	</div>
	<div class="panel_ct">
		<div class="title">Matching Sequences</div>
		<div style="clear: both"></div>
		<div class="panelContent">
			#parse("pages/blast/seq.table.html")
			<div class="notes">
				<p> * Hover over an Eval to View the alignment </p>
				<p> * Click on a row to see alignment details </p>
				<p> * Blast results were computed using NCBI Blast 2.2.18 XML output. Jobs before 12/17/09 used version 2.2.15 </p>
			</div>
		</div>
	</div>

<script type="text/javascript">
<!--
function loadSeqAlignment(el, idx) {
	el.html('<div class="loadingDiv"> Loading ... <img src="$ctx.siteUrl/images/loading.gif" /> </div>');
	$.getJSON("$ctx.siteUrl/ws/blast/getSequenceAlignment", 
			{ 
				jobId: '$job.jobId', 
				seqIndex: idx
			}, function(obj) { 
				var tpl = $('#sa_tpl').html();
				var html = Mustache.render(tpl, obj);
				el.html(html);
			}
	);	
}

var activeSeqAlignmentDiv = null;
function tblRowClick(nRow, aData, iDisplayIndex) {
	var tbl = $(nRow).closest('table')
	$('tr', tbl).removeClass('selected');
	$(nRow).addClass('selected');
	
	if(activeSeqAlignmentDiv) {
		activeSeqAlignmentDiv.remove();
	}
	activeSeqAlignmentDiv = $('<div class="panel_ct"/>');
	activeSeqAlignmentDiv.appendTo('#blast_ct');
	console.log(arguments);
	loadSeqAlignment(activeSeqAlignmentDiv, iDisplayIndex);
}

function onRowCreated(nRow, aData, iDisplayIndex) {
	$(nRow).click(function() {
		tblRowClick(nRow, aData, iDisplayIndex);
	});
	
	var td = $($('td', nRow)[1]); //eval el
	var txt = td.html();
	td.html('<a href="#" onclick="return false;" title="Tooltip ! ... \n Todo: eval alignment show in tooltip... should be good enough \n\n Jovica">'+txt+'</a>');
}

function subjectTblLink(data){
	return '<a href="#" onclick="return false;">'+data+'</a>';
}
function renderExportCheckBox() {
	return '<input type="checkbox" onclick="event.stopPropagation();"/>';
}
//-->
</script>

<script id="sa_tpl" type="text/html">
	#parse("pages/blast/seq.alignment.tpl.html")
</script>

</div>