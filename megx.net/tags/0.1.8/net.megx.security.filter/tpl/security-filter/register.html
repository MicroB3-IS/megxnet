<style>
	.registration-wrapper{
		padding: 15px;
	}
	.registraton-field-label{
		width: 150px;
	}
	.input-wrapper{
		margin: 5px;
	}
	
	.register-action{
		float: left;
		width: 90px;
		margin: 10px;
	}
	.required{
		color: #800;
	}
	.notification-entry{
		padding: 10px;
		/*background: #AAA;*/
		color: #A00;
	}
	.invalid{
		background: #FDD;
	}
</style>
<script type="text/javascript" src="http://www.google.com/recaptcha/api/js/recaptcha_ajax.js"></script>

<script type="text/javascript">
	$(document).ready(function(){
		$('#btn-cancel').click(function(){
			window.location='$ctx.siteUrl/';
		});
		
		var N = {
				notify: function(){
					var m = [];
					for (var  i = 0; i < arguments.length; i++){
						m.push([
							'<div class="notification-entry">', 
								arguments[i].toString(),
							'</div>'
						].join(''));
					}
					$('.notifications').append(m.join(''));
				},
				clear:function(){
					$('.notifications').html('');
				}
		};
		
		var loadReCaptcha = function(){
			// re-captcha widget
			Recaptcha.create("6LfARNUSAAAAAG5g9ad_DArzhQqt84x-5CtNOo3U",
				"recaptcha_widget_wrapper",
				{
					theme: "red",
					callback: Recaptcha.focus_response_field
				}
			);
		};
		
		
		$('#btn-register').click(function(){
			N.clear();
			$('input').removeClass('invalid');
			var valid = true;
			var pass = $("input[name='pass']").val() || '';
			var rePass = $("input[name='rePass']").val() || '';
			
			if($.trim(pass) != $.trim(rePass)){
				N.notify('Password must match!');
				return;
			}
			
			
			var required = {
			   'logname': 'Please enter the username.',
			   'email': 'Please enter the email.',
			   'pass': 'Please enter the password.'
			};
			
			for(var sel in required){
				if(required.hasOwnProperty(sel)){
					var val = $.trim($("input[name='"+sel+"']").val() || '');
					if(val == ''){
						N.notify(required[sel]);
						$("input[name='"+sel+"']").addClass('invalid');
						valid=false;
					}
					else if(sel == 'logname'){
						if(!/^[a-zA-Z0-9_\\.\\-]+$/.test(val)){
							N.notify("Please enter valid username. The username can be any combination of letters, numbers, underscore dot or a dash.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
						else if(val.length < 3 || val.length > 20){
							N.notify("The length of the username must be between 3 and 20 characters long.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
					else if(sel == 'email'){
						if(!(/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i.test(val))){
							N.notify("Please enter valid email.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
					else if(sel == 'pass'){
						if(val.length < 3 || val.length > 20){
							N.notify("The length of the password must be between 3 and 20 characters long.");
							$("input[name='"+sel+"']").addClass('invalid');
							valid=false;
						}
					}
				}
			}
			
			if(!valid){
				return;
			}
			
			
			
			
			$.ajax({
				url:'$ctx.siteUrl/ws/register',
				type: 'POST',
				data: {
					logname: $('input[name=logname]').val(),
					firstName: $('input[name=firstName]').val(),
					lastName: $('input[name=lastName]').val(),
					initials: $('input[name=initials]').val(),
					email: $('input[name=email]').val(),
					challenge: Recaptcha.get_challenge(),
					response: Recaptcha.get_response(),
					pass: pass
				},
				success: function(data){
					if(data.error){
						if(data.reason == 'verification-params-error'){
							N.notify('There was a problem when verifying the captcha. Please try again.');
							loadReCaptcha();
						}else if(data.reason == 'incomplete-parameters'){
							N.notify('Some of the required values for registration are missing. Please fill the form correctly and try again.');
						}else if (data.reason == 'verification-failed'){
							N.notify('Incorrect captcha. Please enter the words correctly.');
							loadReCaptcha();
						}else{
							N.notify(data.message);
						}
					}else{
						$('#register-form').submit();
					}
				},
				error: function(){
					N.notify('We are sorry, but your registration could not be processed at this moment. Please try again later or contact the administrator.');
				}
			});
			//Recaptcha.destroy();
		});
		
		loadReCaptcha();
		
		
	});
</script>

<div class="registration-wrapper">
	Please fill up the following form to register your account on Megx.net.
	<div class="notifications">
		
	</div>
	<form id="register-form" method="post" action="$ctx.siteUrl/register/doRegistration">
		<div class="input-wrapper">
			<label class="registraton-field-label">Username:<span class="required">*</span></label>
			<input type="text" name="logname">
		</div>
		<div class="input-wrapper">
			<label class="registraton-field-label">e-mail:<span class="required">*</span></label>
			<input type="text" name="email">
		</div>
		
		<div class="input-wrapper">
			<label class="registraton-field-label">Password:<span class="required">*</span></label>
			<input type="password" name="pass">
			<label class="registraton-field-label">Repeat Password:<span class="required">*</span></label>
			<input type="password" name="rePass">
		</div>
		
		<div class="input-wrapper">
			<label class="registraton-field-label">First Name:</label>
			<input type="text" name="firstName">
		</div>
		
		<div class="input-wrapper">
			<label class="registraton-field-label">Last Name:</label>
			<input type="text" name="lastName">
		</div>
		
		<div class="input-wrapper">
			<label class="registraton-field-label">Initials:</label>
			<input type="text" name="initials">
		</div>
		
		<div id="recaptcha_widget_wrapper">
		
		</div>
		
		
		<div>
			<input type="button" value="Register" class="register-action" id="btn-register">
			<input type="button" value="Cancel" class="register-action" id="btn-cancel">
		</div>
	</form>
</div>