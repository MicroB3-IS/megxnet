<link href="$ctx.siteUrl/net.megx.form-widget/css/alpaca-1.1.3.css" rel="stylesheet" type="text/css">
<link href="$ctx.siteUrl/net.megx.osd.registry/stylesheets/osdRegistry.css" rel="stylesheet" type="text/css">
<link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
<script type="text/javascript" src="$ctx.siteUrl/net.megx.form-widget/js/alpaca-full-1.1.3.min.js"></script>
<script type="text/javascript" src="$ctx.siteUrl/net.megx.form-widget/js/megx-form-widget-0.1.min.js"></script>


<div id="participationForm" style="padding: 15px"></div>

<script type="text/javascript">
#if(($req.user && !$req.user.empty) && ($req.servletRequset.session.getAttribute("userEmail")))
	user = '$req.user.name';
	email = '$req.servletRequset.session.getAttribute("userEmail")';
#else
	user = null;
    email = null;
#end

var MegxFormWidget = new MegxFormWidget({
    target: "participationForm",
    schemaLocation: ctx.siteUrl + "/net.megx.osd.registry/data/participation-schema.json",
    optionsLocation: ctx.siteUrl + "/net.megx.osd.registry/data/participation-options.json",
    formId: "participation-form",
    parentView: "VIEW_JQUERYUI_CREATE",
    postRender: function(field) {

        var form = field.form;
        var fieldSet = form.field[0];
        var url = form.attributes.action;
        var ajaxMethod = form.attributes.method;
        
        toastr.options = {
    			timeOut: 15000,
    			positionClass: "toast-top-center"
            };
        
        jQuery(".alpaca-fieldset").keyup(function() {
            if (field.isValid(true)) {
            	form.enableSubmitButton();
            }
        });
		
        if (user != null && email != null) {

            var contactName = field.childrenByPropertyId["contactName"];
            contactName.setValue(user);
            var contactEmail = field.childrenByPropertyId["contactEmail"];
            contactEmail.setValue(email);

            var contactNameInput = fieldSet[1];
            contactNameInput.readOnly = true;

            var contactEmailInput = fieldSet[2];
            contactEmailInput.readOnly = true;
            
            if (form) {

                form.registerSubmitHandler(function(e, form) {
                    return false;
                });
                
                form.buttons.submit.click(function() {
                	
                	form.disableSubmitButton();

                	if (field.isValid(true)) {

                        var data = field.getValue();
                        data.json = JSON.stringify(field.getValue());
                        jQuery.ajax({
                            type: ajaxMethod,
                            url: url,
                            data: data,
                            success: function(data, textStatus, jqXHR) {
                            	
                            	if(data.redirectUrl && data.redirectUrl != ""){
                            		toastr.info("Your submission was successfull. Thanks!");
                            		setTimeout(function() {
                            			document.location.href = data.redirectUrl;
                            		}, 3000);
                            		
                            	} else {
                            		
                            		if(data.message && data.message != ""){
                            			toastr.info(data.message);
                            			setTimeout(function() {
                            				document.location.href = ctx.siteUrl;
                                		}, 3000);
                            		} else{
                            			toastr.info("Your submission was successfull. Thanks!");
                                		setTimeout(function() {
                                			document.location.href = ctx.siteUrl;
                                		}, 3000);
                                		
                            		}
                            	}
                            },
                            error: function(data, textStatus, jqXHR) {

                            	form.enableSubmitButton();
                            	
                            	if(data.responseJSON && data.responseJSON != ""){
                            		
                            		var responseMsg = data.responseJSON;
                                	
                                	if(responseMsg.redirectUrl && responseMsg.redirectUrl != ""){
                                		document.location.href = responseMsg.redirectUrl;
                                	} else {
                                		
                                		if(responseMsg.message && responseMsg.message != ""){
                                			toastr.error(responseMsg.message, jqXHR);
                                		} else{
                                			toastr.error("Server error, please try again later.", jqXHR);
                                		}
                                	}
                            	} else {
                            		toastr.error("Server error, please try again later.", jqXHR);
                            	}
                            }
                        });
                    }
                });
                jQuery("#" + MegxFormWidget.cfg.target + "-loading-animation").remove();
            }

        } else {
        	
        	toastr.info("You need to be logged in, in case you don't have user you can use this form name and mail to create one.");
        	var userName = field.childrenByPropertyId["contactName"];
        	var userMail = field.childrenByPropertyId["contactEmail"];
        	
        	form.registerSubmitHandler(function(e, form) {
        		return false;
        	});
        	form.buttons.submit.click(function() {
        	    if (confirm("Do you want to use your entered name and email to create megx.net user in order to submit participation?!") == true) {
        	    	document.location.href = "$ctx.siteUrl/register?userName="+userName.getValue()+"&userMail="+userMail.getValue();
        	    } 
        	});
        	jQuery("#" + MegxFormWidget.cfg.target + "-loading-animation").remove();
           	
        }
    }
});
 
</script>
