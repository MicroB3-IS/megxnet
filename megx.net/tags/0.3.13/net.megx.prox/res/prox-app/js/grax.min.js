/**
 * GraX - v0.3.4 - 2013-03-29
 * Copyright (c) 2013 Max-Planck-Institut Bremen
*/
(function(){"use strict";var e=e||{};e.Exception=function(e,t){this.name=e||"unknown",this.message=t||"no description"},e.Exception.prototype.constructor=e.Exception,e.Exception.prototype.toString=function(){return"["+this.name+"] "+this.message},e.DuplicateIdException=function(t){e.Exception.call(this,"DuplicateIdException",t)},e.DuplicateIdException.prototype=Object.create(e.Exception.prototype),e.DuplicateIdException.prototype.constructor=e.DuplicateIdException,e.AbstractMethodError=function(t){e.Exception.call(this,"AbstractMethodError",t)},e.AbstractMethodError.prototype=Object.create(e.Exception.prototype),e.AbstractMethodError.prototype.constructor=e.AbstractMethodError,e.Common={clone:function(t,i){var s,o,r;i=i||!1,o={};for(s in t)t.hasOwnProperty(s)&&(r=t[s],o[s]=i&&e.Common.isClonable(r)?r.clone():i&&e.Common.isArray(r)?e.Common.cloneArray(r):r);return o},isArray:function(e){return"object"==typeof e&&e.length},isClonable:function(e){return e&&"function"==typeof e.clone},cloneArray:function(t){var i,s,o,r=[];for(i=0,s=t.length;s>i;i++)o=t[i],e.Common.isClonable(o)?r.push(o.clone(o)):r.push(o);return r},getValueByNestedKey:function(e,t){var i,s,o,r;for(r=e.split("."),o=t,i=0,s=r.length;s>i;i++)if(o=o[r[i]],!o)return void 0;return o},reverseId:function(t){var i,s,o;for(o=t.split(e.Common.SEPARATOR),s=o[o.length-1],i=o.length-2;i>=0;i--)s+=e.Common.SEPARATOR+o[i];return s}},e.Common.SEPARATOR="|",e.Common.NORMAL=new THREE.Vector3(0,0,1),e.HashMap=function(e){this.clear(),e&&this.putAll(e)},e.HashMap.prototype.constructor=e.HashMap,e.HashMap.prototype.clear=function(){this.map={},this.mapSize=0},e.HashMap.prototype.clone=function(){return new e.HashMap(e.Common.clone(this.map,!0))},e.HashMap.prototype.containsKey=function(e){return this.map.hasOwnProperty(e)},e.HashMap.prototype.containsValue=function(e){var t;for(t in this.map)if(this.map.hasOwnProperty(t)&&t===e)return!0;return!1},e.HashMap.prototype.each=function(e){var t;for(t in this.map)if(this.map.hasOwnProperty(t)&&void 0!==this.map[t]&&e.call(this,t,this.map[t])===!1)break},e.HashMap.prototype.eachInstance=function(t,i){var s,o,r,n;s=this,o=new e.HashMap,r=function(r,a){if("object"!=typeof a)i.call(s,r,a);else if(n=e.Common.getValueByNestedKey(t,a),n&&!o.get(n)&&(o.put(n,!0),i.call(s,r,a)===!1))return!1},s.each(r)},e.HashMap.prototype.entrySet=function(){return e.Common.clone(this.map)},e.HashMap.prototype.get=function(e){return this.map[e]},e.HashMap.prototype.first=function(){var e=null;return this.each(function(t,i){return e=i,!1}),e},e.HashMap.prototype.isEmpty=function(){return 0===this.mapSize},e.HashMap.prototype.keySet=function(){var e,t;t=[];for(e in this.map)this.map.hasOwnProperty(e)&&t.push(e);return t},e.HashMap.prototype.put=function(e,t){return e=""+e,this.containsKey(e)||this.mapSize++,this.map[e]=t,this.map[e]},e.HashMap.prototype.putAll=function(e){var t;for(t in e)e.hasOwnProperty(t)&&(this.map[t]=e[t],this.mapSize++)},e.HashMap.prototype.remove=function(e){var t=null;return this.containsKey(e)&&(t=this.map[e],delete this.map[e],this.mapSize--),t},e.HashMap.prototype.size=function(){return this.mapSize},e.HashMap.prototype.values=function(){var e,t=[];for(e in this.map)this.map.hasOwnProperty(e)&&t.push(this.map[e]);return t},e.HashMap.prototype.toJSON=function(){var e,t;return e=!0,t="{ ",this.each(function(i,s){e||(e=!1,t+=", "),t+='"'+i+'": '+(s.toJSON?s.toJSON():""+s)}),t+=" }"},e.HashMap.prototype.equals=function(t){var i,s;return this===t?!0:t instanceof e.HashMap&&this.size()===t.size()?(s=!0,this.each(function(e,o){if(i=t.get(e),o.equals){if(!o.equals(i))return s=!1,!1}else if(o!==i)return s=!1,!1}),s):!1},e.HashMap.prototype.toString=function(){return this.toJSON()},e.AbstractParser=function(){},e.AbstractParser.prototype.constructor=e.AbstractParser,e.AbstractParser.prototype.parse=function(){throw new e.AbstractMethodError("Please override the parse function")},e.GraphMLParser=function(){e.AbstractParser.call(this)},e.GraphMLParser.prototype=Object.create(e.AbstractParser.prototype),e.GraphMLParser.prototype.constructor=e.GraphMLParser,e.GraphMLParser.prototype.parse=function(t){var i,s,o,r,n,a,h,d,c,p=!0;return r=$(t).children("graphml:first"),n=r.children("graph:first"),o=new e.Graph({directed:"directed"===n.attr("edgedefault")?!0:!1}),h=new e.HashMap,n.children().map(function(t,r){var n,d,c,u,g,l,E,m=!1;if(n=$(r),d={},"node"===n[0].nodeName){for(c=n.children("data"),i=0,s=c.length;s>i;i++)u=$(c[i]),g=u.attr("key"),"x"===g||"y"===g||"size"===g?d[g]=parseFloat(u.text()):"r"===g||"g"===g||"b"===g?d[g]=parseInt(u.text(),10)/255:p&&"gxpartition"===g?(m=!0,d[g]=parseInt(u.text(),10)):d[g]=u.text();m||(p=!1),o.addGraphItem(new e.Node(n.attr("id"),d))}else if("edge"===n[0].nodeName){for(l=n.attr("source"),E=n.attr("target"),c=n.children("data"),d.direction=o.directed?e.Edge.DIRECTION_BOTH:e.Edge.DIRECTION_NONE,i=0,s=c.length;s>i;i++)u=$(c[i]),g=u.attr("key"),"weight"===g?d[g]=parseFloat(u.text()):"source"===g?l=u.text():"target"===g?E=u.text():d[g]=u.text();a=new e.Edge(l,E,d),h.put(a.id,a)}}),o.partitioned=p,h.each(function(t,i){d=o.items.get(i.sourceId),c=o.items.get(i.targetId),o.directed?h.containsKey(e.Common.reverseId(i.id))?(i.direction=e.Edge.DIRECTION_BOTH,d.edges.push(i)):(i.direction=e.Edge.DIRECTION_ONE,d.edges.push(i),c.edges.push(i)):(i.direction=e.Edge.DIRECTION_NONE,d.edges.push(i),c.edges.push(new e.Edge(i.targetId,i.sourceId,i.options)))}),o},e.Processor=function(e,t){this.renderer=e,this.file=t},e.Processor.prototype.constructor=e.Processor,e.Processor.prototype.start=function(e){var t,i;t=this,Blob&&this.file instanceof Blob?(i=new FileReader,i.onload=function(e){t.onLoad($($.parseXML(e.target.result))[0])},i.readAsText(this.file)):$.ajax({type:"GET",url:this.file,dataType:"xml",success:$.proxy(e,this)})},e.GraphItem=function(t){this.id=t?""+t:"AutoID-"+e.GraphItem.idCount++,this.edges=null,this.edgesBorrowed=[],this.costs=1,this.changed=!1},e.GraphItem.prototype.constructor=e.GraphItem,e.GraphItem.prototype.setChangeFlag=function(){this.changed=!0},e.GraphItem.prototype.idSet=function(){return[this.id]},e.GraphItem.prototype.getNode=function(e){return this.id===e?this:null},e.GraphItem.prototype.hasNode=function(e){return this.id===e},e.GraphItem.prototype.hasChanged=function(){return this.changed?(this.changed=!1,!0):!1},e.GraphItem.prototype.getDegree=function(){return e.Common.isArray(this.edges)?this.edges.length:0},e.GraphItem.prototype.equals=function(t){return this===t||t instanceof e.GraphItem&&this.id===t.id},e.GraphItem.prototype.toString=function(){return"GraphItem("+this.id+")"},e.GraphItem.idCount=0,e.Node=function(t,i){e.GraphItem.call(this,t),this.attributes=i||{},this.x=this.attributes.x||0,this.y=this.attributes.y||0,this.size=this.attributes.size||1,this.label=this.attributes.label||this.attributes.name||t,this.setColor(this.attributes.r,this.attributes.g,this.attributes.b),this.edges=this.attributes.edges||[],this.partition=this.attributes.gxpartition},e.Node.prototype=Object.create(e.GraphItem.prototype),e.Node.prototype.constructor=e.Node,e.Node.prototype.setPosition=function(e,t){this.x=e,this.y=t,this.setChangeFlag()},e.Node.prototype.setSize=function(e){this.size=Math.max(1,e),this.setChangeFlag()},e.Node.prototype.setColor=function(e,t,i){"number"==typeof e&&"number"==typeof t&&"number"==typeof i?(this.r=Math.min(Math.max(0,e),1),this.g=Math.min(Math.max(0,t),1),this.b=Math.min(Math.max(0,i),1)):(this.r=0,this.g=0,this.b=0),this.setChangeFlag()},e.Node.prototype.setLabel=function(e){this.label=e,this.setChangeFlag()},e.Node.prototype.equals=function(t){var i,s,o,r;if(this===t)return!0;if(t instanceof e.Node&&this.id===t.id&&this.x===t.x&&this.y===t.y&&this.size===t.size&&this.label===t.label&&this.r===t.r&&this.g===t.g&&this.b===t.b&&this.costs===t.costs&&this.edges.length===t.edges.length){for(s=this.edges.length,i=0;s>i;i++)if(o=this.edges[i],r=t.edges[i],!o.equals(r))return!1;return!0}return!1},e.Node.prototype.clone=function(){var t=this.attributes;return t.x=this.x,t.y=this.y,t.size=this.size,t.label=this.label,t.r=this.r,t.g=this.g,t.b=this.b,t.edges=this.edges,new e.Node(this.id,t)},e.Node.prototype.toString=function(){return"Node("+(this.label.length>0?this.label:this.id)+")"},e.Edge=function(t,i,s){this.attributes=s||{},this.sourceId=t instanceof e.Node?t.id:t,this.targetId=i instanceof e.Node?i.id:i,this.id=this.sourceId+e.Common.SEPARATOR+this.targetId,this.direction=this.attributes.direction||e.Edge.DIRECTION_NONE,this.weight=this.attributes.weight||1,this.thickness=Math.max(1,this.weight)},e.Edge.prototype.constructor=e.Edge,e.Edge.prototype.equals=function(e){return this===e||this.direction===e.direction&&this.weight===e.weight&&this.sourceId===e.sourceId&&this.targetId===e.targetId},e.Edge.prototype.clone=function(){var t={direction:this.direction,weight:this.weight};return new e.Edge(this.sourceId,this.targetId,t)},e.Edge.prototype.toString=function(){return"Edge ("+this.sourceId+" -> "+this.targetId+")"},e.Edge.DIRECTION_NONE=0,e.Edge.DIRECTION_ONE=1,e.Edge.DIRECTION_BOTH=2,e.Graph=function(t,i){t=t||{},t&&(this.directed=t.directed||!1),this.items=i?i:new e.HashMap,this.partitioned=!1,this.cachedClusters=[]},e.Graph.prototype.constructor=e.Graph,e.Graph.prototype.addGraphItem=function(t){if(this.items.containsKey(t.id))throw new e.DuplicateIdException("Another node with ID "+t.id+" has already been added");this.items.put(t.id,t)},e.Graph.prototype.getOrder=function(){return this.items.size()},e.Graph.prototype.getNode=function(e){var t=this.items.get(e);return t?t.getNode(e):null},e.Graph.prototype.expand=function(e){var t;t=this,this.cachedClusters.push(e),e.innerNodes.each(function(e,i){t.items.put(e,i)})},e.Graph.prototype.fullExpand=function(){var t=this;this.items.eachInstance("id",function(i,s){s instanceof e.Cluster&&t.expand(s)}),this.cachedClusters=[]},e.Graph.prototype.compress=function(){var e,t,i,s,o,r;for(e=this,o=function(t){e.items.put(t,s)},t=0,i=this.cachedClusters.length;i>t;t++)s=this.cachedClusters[t],s.innerNodes.each(o);return r=this.cachedClusters.slice(),this.cachedClusters=[],r},e.Graph.prototype.assignOuterEdges=function(){var t,i,s,o,r,n,a,h;t=this,h=new e.HashMap,this.items.eachInstance("id",function(d,c){for(i=0,s=c.edges.length;s>i;i++)o=c.edges[i],h.get(o.id)!==!0?(h.put(o.id,!0),h.put(e.Common.reverseId(o.id),!0),r=t.items.get(o.sourceId),n=t.items.get(o.targetId),a=r.edges.length<n.edges.length?n:r,a.edgesBorrowed.push(new e.EdgeBorrowed(o,t.getNode(o.sourceId),t.getNode(o.targetId)))):(h.put(o.id,!1),h.put(e.Common.reverseId(o.id),!1))})},e.Graph.prototype.clone=function(){var t={directed:this.directed};return new e.Graph(t,this.items.clone())},e.Graph.prototype.equals=function(t){return this===t||t instanceof e.Graph&&this.directed===t.directed&&this.items.equals(t.items)},e.Graph.prototype.toString=function(){return"Graph ("+this.items.size()+" entries)"},e.Cluster=function(t){e.GraphItem.call(this,t.id),this.innerNodes=new e.HashMap,this.innerNodes.put(t.id,t),this.innerEdges=[],this.edges=t.edges.slice()},e.Cluster.prototype=Object.create(e.GraphItem.prototype),e.Cluster.prototype.constructor=e.Cluster,e.Cluster.prototype.add=function(t){t instanceof e.Node?(this.innerNodes.put(t.id,t),this.assignEdges(t.edges)):(this.innerNodes.putAll(t.innerNodes.map),this.innerEdges=this.innerEdges.concat(t.innerEdges),this.assignEdges(t.edges)),this.id+=e.Common.SEPARATOR+(""+t.id),this.costs=this.innerNodes.size()+this.edges.length},e.Cluster.prototype.assignEdges=function(t){var i,s,o,r,n;for(n=new e.HashMap,r=[],this.edges=this.edges.concat(t),i=0,s=this.edges.length;s>i;i++)o=this.edges[i],n.get(o.id)!==!0&&(n.put(o.id,!0),this.innerNodes.containsKey(o.sourceId)&&this.innerNodes.containsKey(o.targetId)?this.innerEdges.push(o):r.push(o));this.edges=r},e.Cluster.prototype.expand=function(){return this.innerNodes},e.Cluster.prototype.hasChanged=function(){var e;return this.change===!0?(this.change=!1,!0):(e=!1,this.innerNodes.each(function(t,i){i.hasChanged()&&(e=!0)}),e)},e.Cluster.prototype.toString=function(){return"Cluster("+this.id+")"},e.Cluster.merge=function(t,i){var s;return t instanceof e.Cluster?(t.add(i),t):i instanceof e.Cluster?(i.add(t),i):(s=new e.Cluster(t),s.add(i),s)},e.Cluster.prototype.idSet=function(){return this.innerNodes.keySet()},e.Cluster.prototype.hasNode=function(t){return this.innerNodes.get(t)instanceof e.Node},e.Cluster.prototype.getNode=function(e){return this.innerNodes.get(e)},e.ForceLayout=function(t){var i=this;this.forceNodes=new e.HashMap,this.minKinetic=t.items.size(),i.equilibrium=1,t.items.each(function(t,s){i.forceNodes.put(t,new e.ForceNode(s)),i.equilibrium<s.size&&(i.equilibrium=s.size)}),this.equilibrium*=5,this.graph=t},e.ForceLayout.prototype.constructor=e.ForceLayout,e.ForceLayout.prototype.run=function(t){var i,s,o,r=this,n=new e.HashMap,a=new Date,h=0,d=new THREE.Vector2;t=t||e.ForceLayout.DEFAULT_TIMEOUT,o=function(t,i){var o,n,a,h,c,p;for(d.set(0,0),r.forceNodes.each(function(e,t){i.node.id!==t.node.id&&(p=r.calcRepulsion(i,t),d.add(p))}),o=0,n=i.node.edges.length;n>o;o++)a=i.node.edges[o],a.sourceId===i.node.id?h=a.targetId:a.targetId===i.node.id&&(h=a.sourceId),c=r.calcAttraction(i,r.forceNodes.get(h)),d.add(c);i.velocity.add(d).multiplyScalar(e.ForceLayout.DEFAULT_DAMPING/r.graph.items.size()),i.pos.add(i.velocity),s+=i.node.size*i.velocity.length()};do s=0,this.forceNodes.each(o),h=new Date-a;while(s>this.minKinetic&&t>h);return this.forceNodes.each(function(e,t){n.put(e,t.apply())}),i=new e.Graph(this.graph.options,n)},e.ForceLayout.prototype.calcRepulsion=function(t,i){var s=t.pos.clone().sub(i.pos),o=t.pos.distanceTo(i.pos);return s.divideScalar(o).multiplyScalar(e.ForceLayout.DEFAULT_REPULSION).divideScalar(o*o)},e.ForceLayout.prototype.calcAttraction=function(t,i){var s=t.pos.clone().sub(i.pos).normalize(),o=t.pos.distanceToSquared(i.pos),r=Math.sqrt(o),n=-e.ForceLayout.DEFAULT_ATTRACTION*(o-this.equilibrium);return n>r?n=r:-r>n&&(n=-r),s.multiplyScalar(n),s},e.ForceLayout.DEFAULT_TIMEOUT=2e3,e.ForceLayout.DEFAULT_REPULSION=9e4,e.ForceLayout.DEFAULT_ATTRACTION=.003,e.ForceLayout.DEFAULT_DAMPING=1,e.ForceNode=function(e){this.node=e,this.pos=new THREE.Vector2(e.x,e.y),this.velocity=new THREE.Vector2(0,0)},e.ForceNode.prototype.constructor=e.ForceNode,e.ForceNode.prototype.apply=function(){return this.node.setPosition(this.pos.x,this.pos.y),this.node},e.EgoNetwork=function(){},e.EgoNetwork.prototype.constructor=e.EgoNetwork,e.EgoNetwork.prototype.create=function(t,i,s,o){var r,n,a,h,d,c,p,u,g,l;for(d=new e.Graph({directed:o.directed}),c=[],r=0,n=s.length;n>r;r++)u=o.getNode(s[r]),c.push(u);do{for(p=[],r=0,n=c.length;n>r;r++)for(u=c[r],d.items.put(u.id,u),a=0,h=u.edges.length;h>a;a++)l=u.edges[a],l.targetId!==u.id?d.items.containsKey(l.targetId)||(g=o.getNode(l.targetId),p.push(g)):i&&(d.items.containsKey(l.sourceId)||(g=o.getNode(l.sourceId),p.push(g)));c=p}while(--t>=0);return d.items.each(function(e,t){var i;for(delete t.partition,i=[],r=0,n=t.edges.length;n>r;r++)l=t.edges[r],(l.sourceId!==t.id&&d.items.containsKey(l.sourceId)||l.targetId!==t.id&&d.items.containsKey(l.targetId))&&i.push(l);t.edges=i}),d},e.NodeSearch=function(t){this.blacklist=new e.HashMap({x:!0,y:!0,z:!0,size:!0,color:!0,r:!0,g:!0,b:!0,edges:!0,gxpartition:!0,costs:!0}),this.entries=t.items},e.NodeSearch.prototype.constructor=e.NodeSearch,e.NodeSearch.prototype.find=function(t){var i=this,s=t.toLowerCase(),o=[];return this.entries.each(function(t,r){var n,a,h=r.attributes,d=[];for(n in h)h.hasOwnProperty(n)&&h[n]&&!i.blacklist.containsKey(n.toLowerCase())&&(a=(""+h[n]).toLowerCase(),(a===s||-1!==a.indexOf(s))&&d.push(n));return d.length>0&&o.push({id:r.id,label:r.label,hits:d}),o.length>=e.NodeSearch.LIMIT?!1:void 0}),o=o.sort(function(e,t){var i,s,o,r;return i=e.label.toLowerCase(),s=t.label.toLowerCase(),s>i?-1:i>s?1:(o=e.id.toLowerCase(),r=t.id.toLowerCase(),r>o?-1:o>r?1:0)}),{data:o,limit:o.length>=e.NodeSearch.LIMIT?o.length:0}},e.NodeSearch.LIMIT=1e3,e.GraphMerger=function(){},e.GraphMerger.prototype.constructor=e.GraphMerger,e.GraphMerger.prototype.edgeCollapse=function(e,t){return t.partitioned?this.usePartitions(t):this.createPartitions(e,t)},e.GraphMerger.prototype.usePartitions=function(t){var i,s,o;return s=new e.HashMap,i=new e.HashMap,t.items.each(function(e,t){i.containsKey(t.partition)?i.get(t.partition).push(t):i.put(t.partition,[t])}),i.each(function(t,i){var o,r,n,a;for(n=i[0],a=new e.Cluster(n),s.put(n.id,a),o=1,r=i.length;r>o;o++)n=i[o],a.add(n),s.put(n.id,a)}),o=new e.Graph(t.options,s),o.assignOuterEdges(),o},e.GraphMerger.prototype.createPartitions=function(t,i){var s,o,r,n,a,h;n=new e.HashMap,a=new e.HashMap,i.items.each(function(t,i){var s=new e.Cluster(i);n.put(t,s),0===i.getDegree()&&a.put(t,s)}),o=n.size(),r=new e.HashMap,s=function(e,i){var s,h,d,c,p;if(r.get(i.id)!==!0){if(c=null,i.getDegree()>0)for(h=i.edges.length,s=0;h>s;s++)d=n.get(i.edges[s].targetId),d.id===i.id&&(d=n.get(i.edges[s].sourceId)),d.id!==i.id&&(!c||d.costs<c.costs)&&(c=d);else h=a.each(function(e,t){t.id!==i.id&&(!c||t.costs<c.costs)&&(c=t)}),c&&(a.remove(i.id),a.remove(c.id));if(c){for(i.add(c),p=c.idSet(),s=0,h=p.length;h>s;s++)n.put(p[s],i);r.put(i.id,!0),0===i.getDegree()&&a.put(i.id,i),o--}else n.put(i.id,i);if(t>=o)return!1}};do n.each(s),r.clear();while(o>t);return h=new e.Graph(i.options,n),h.assignOuterEdges(),h},e.EdgeBorrowed=function(e,t,i){this.edge=e,this.source=t,this.target=i},e.EdgeBorrowed.prototype.constructor=e.EdgeBorrowed,e.TextGenerator=function(t){if(t!==e.TextGenerator.getInstance)throw new e.AbstractMethodError("Singleton. No instantiation allowed.");this.charWidth=0,this.charHeight=0,this.charWidthRel=0,this.charHeightRel=0,this.fresh=!0},e.TextGenerator.prototype.constructor=e.TextGenerator,e.TextGenerator.prototype.init=function(e,t){this.fresh===!0&&(this.fresh=!1,t=t||{},this.charWidth=t.charWidth||18,this.charHeight=t.charHeight||36,e&&e.image?(this.charWidthRel=this.charWidth/e.image.width,this.charHeightRel=this.charHeight/e.image.height):(this.charWidthRel=this.charWidth,this.charHeightRel=this.charHeight),t.charsPerRow=t.charsPerRow||14,this.alphabet=new THREE.MeshBasicMaterial({map:e}))},e.TextGenerator.prototype.buildLabel=function(t,i){var s,o,r,n,a,h,d,c,p,u,g,l,E,m,f,y;for(g=t.size/this.charHeight,m=this.charWidth*g,f=this.charHeight/2*g,l=t.x+t.size,E=t.y,y=i.vertices.length,s=0,o=t.label.length;o>s;s++)u=4*s+y,d=t.label.charCodeAt(s),i.vertices.push(new THREE.Vector3(l+s*m,E+f,0),new THREE.Vector3(l+(s+1)*m,E+f,0),new THREE.Vector3(l+s*m,E-f,0),new THREE.Vector3(l+(s+1)*m,E-f,0)),i.faces.push(new THREE.Face4(u,u+2,u+3,u+1,e.Common.NORMAL,e.TextGenerator.DEFAULT_COLOR,0)),c=Math.floor((d-e.TextGenerator.ASCII_START)/14),p=(d-e.TextGenerator.ASCII_START)%14,r=1-(c+1)*this.charHeightRel,n=1-c*this.charHeightRel,a=p*this.charWidthRel,h=a+this.charWidthRel,i.faceVertexUvs[0].push([new THREE.Vector2(a,n),new THREE.Vector2(a,r),new THREE.Vector2(h,r),new THREE.Vector2(h,n)])},e.TextGenerator.getInstance=function(){return this.instance?this.instance:(this.instance=new e.TextGenerator(e.TextGenerator.getInstance),this.instance)},e.TextGenerator.ASCII_START=32,e.TextGenerator.ASCII_STOP=127,e.TextGenerator.DEFAULT_MATERIAL_FACE=new THREE.MeshFaceMaterial,e.TextGenerator.DEFAULT_COLOR=new THREE.Color(0),e.GraphItemGL=function(e){this.everyEdge=!0,this.data=e,this.edges=[],this.labelMesh=null,this.edgeMesh=null,this.edgeGeometryOriginal=null,this.nodeMesh=null,this.applyItem(e)},e.GraphItemGL.prototype.constructor=e.GraphItemGL,e.GraphItemGL.prototype.addNode=function(t,i,s){var o,r,n,a;void 0===s&&(s=0,a=!0),r=t.size/2,n=t.size/2,a?i.vertices.push(new THREE.Vector3(-r,n,0),new THREE.Vector3(r,n,0),new THREE.Vector3(-r,-n,0),new THREE.Vector3(r,-n,0)):i.vertices.push(new THREE.Vector3(-r+t.x,n+t.y,0),new THREE.Vector3(r+t.x,n+t.y,0),new THREE.Vector3(-r+t.x,-n+t.y,0),new THREE.Vector3(r+t.x,-n+t.y,0)),o=new THREE.Face4(s,s+2,s+3,s+1,e.Common.NORMAL,(new THREE.Color).setRGB(t.r,t.g,t.b)),o.nodeId=t.id,i.faces.push(o)},e.GraphItemGL.prototype.applyItem=function(t){var i,s,o,r,n,a,h,d,c,p,u,g,l,E,m,f;if(i=this,c=e.TextGenerator.getInstance(),t instanceof e.Cluster){if(n=new THREE.Geometry,r=t.expand(),s=0,a=new THREE.Geometry,r.each(function(e,t){i.addNode(t,n,s),t.label&&t.label.length>0&&c.buildLabel(t,a,s),s+=4}),d=new THREE.Mesh(a,new THREE.MeshFaceMaterial([c.alphabet])),d.position.z=-.5+Math.random()/10,h=new THREE.Mesh(n,new THREE.MeshBasicMaterial({shading:THREE.FlatShading,vertexColors:THREE.FaceColors})),t.innerEdges.length>0||t.edgesBorrowed.length>0){for(p=new THREE.Geometry,E=new e.HashMap,s=0,o=t.innerEdges.length;o>s;s++)u=t.innerEdges[s],m=u.id,f=e.Common.reverseId(u.id),E.get(m)!==!0&&E.get(f)!==!0?(E.put(m,!0),g=t.innerNodes.get(u.sourceId),l=t.innerNodes.get(u.targetId),e.EdgeGL.createGeometry(p,u,g,l)):(E.put(m,!1),E.put(f,!1));this.edgeGeometryOriginal=p.clone(),this.buildEdgesBorrowed(p),this.edgeMesh=new THREE.Mesh(p,e.EdgeGL.MATERIAL_FACECOLOR)}}else n=new THREE.Geometry,this.addNode(t,n),h=new THREE.Mesh(n,new THREE.MeshBasicMaterial({shading:THREE.FlatShading,vertexColors:THREE.FaceColors})),h.position.x=t.x,h.position.y=t.y;this.labelMesh=d,this.nodeMesh=h},e.GraphItemGL.prototype.addEdgeGL=function(e){this.edges.push(e)},e.GraphItemGL.prototype.buildEdgesBorrowed=function(t,i){var s,o,r;for(s=0,o=this.data.edgesBorrowed.length;o>s;s++)r=this.data.edgesBorrowed[s],i?i.getNode(r.edge.sourceId)||i.getNode(r.edge.targetId)||e.EdgeGL.createGeometry(t,r.edge,r.source,r.target):e.EdgeGL.createGeometry(t,r.edge,r.source,r.target);this.everyEdge=!i},e.GraphItemGL.prototype.edgeReset=function(t,i){var s;!this.edgeGeometryOriginal||!i&&this.everyEdge||(t.remove(this.edgeMesh),s=this.edgeGeometryOriginal.clone(),this.buildEdgesBorrowed(s,i),this.edgeMesh=new THREE.Mesh(s,e.EdgeGL.MATERIAL_FACECOLOR),t.add(this.edgeMesh))},e.GraphItemGL.prototype.addToScene=function(e,t){t.add(this.nodeMesh),this.edgeMesh&&e.add(this.edgeMesh),this.labelMesh&&e.add(this.labelMesh)},e.GraphItemGL.prototype.removeFromScene=function(e,t){t.remove(this.nodeMesh),this.edgeMesh&&e.remove(this.edgeMesh),this.labelMesh&&e.remove(this.labelMesh)},e.GraphItemGL.prototype.setPosition=function(e,t){this.nodeMesh.position.x=e,this.nodeMesh.position.y=t,this.edgeMesh&&(this.edgeMesh.position.x=e,this.edgeMesh.position.y=t)},e.EdgeGL=function(t,i,s){var o;this.data=t,this.mesh=null,o=new THREE.Geometry,e.EdgeGL.createGeometry(o,this.data,i,s),this.mesh=new THREE.Mesh(o,e.EdgeGL.MATERIAL_FACECOLOR)},e.EdgeGL.prototype.constructor=e.EdgeGL,e.EdgeGL.prototype.update=function(t,i){var s,o,r,n;for(r=e.EdgeGL.calculateVertices(this.data,t,i),n=this.mesh.geometry.vertices.length-r.length,s=0,o=r.length;o>s;s++)this.mesh.geometry.vertices[n+s].copy(r[s]);this.mesh.geometry.verticesNeedUpdate=!0},e.EdgeGL.prototype.addToScene=function(e){e.add(this.mesh)},e.EdgeGL.prototype.removeFromScene=function(e){e.remove(this.mesh)},e.EdgeGL.calculateVertices=function(t,i,s){var o,r,n,a,h,d,c,p,u,g,l,E,m;for(n=new THREE.Vector2(i.x,i.y),a=new THREE.Vector2(s.x,s.y),h=Math.atan2(a.y-n.y,a.x-n.x),u=n.distanceTo(a)/2,g=t.thickness/2,c=(new THREE.Matrix4).makeRotationZ(h),p=(new THREE.Matrix4).makeTranslation((i.x+s.x)/2,(i.y+s.y)/2,0),l=i.size/2,E=s.size/2,m=6*Math.sqrt(t.thickness),t.direction===e.Edge.DIRECTION_ONE?(m=Math.min(m,2*u-1.5*l-E),m=Math.max(m,3*t.thickness),d=[new THREE.Vector3(-u+l,g,-1),new THREE.Vector3(-u+l,-g,-1),new THREE.Vector3(u-E-m,-g,-1),new THREE.Vector3(u-E-m,g,-1),new THREE.Vector3(u-E-m,m/2,-1),new THREE.Vector3(u-E-m,-m/2,-1),new THREE.Vector3(u-E,0,-1)]):t.direction===e.Edge.DIRECTION_BOTH?(m=Math.min(m,u-.7*l-.7*E),m=Math.max(m,3*t.thickness),d=[new THREE.Vector3(-u+l+m,g,-1),new THREE.Vector3(-u+l+m,-g,-1),new THREE.Vector3(u-E-m,-g,-1),new THREE.Vector3(u-E-m,g,-1),new THREE.Vector3(u-E-m,m/2,-1),new THREE.Vector3(u-E-m,-m/2,-1),new THREE.Vector3(u-E,0,-1),new THREE.Vector3(-u+l+m,-m/2,-1),new THREE.Vector3(-u+l+m,m/2,-1),new THREE.Vector3(-u+l,0,-1)]):d=[new THREE.Vector3(-u,g,-1),new THREE.Vector3(-u,-g,-1),new THREE.Vector3(u,-g,-1),new THREE.Vector3(u,g,-1)],o=0,r=d.length;r>o;o++)d[o].applyMatrix4(c).applyMatrix4(p);return d},e.EdgeGL.createGeometry=function(t,i,s,o){var r,n;n=0>i.weight||i.attributes.correlogValue&&0>i.attributes.correlogValue?e.EdgeGL.COLOR_NEGATIVE:e.EdgeGL.COLOR_POSITIVE,r=t.vertices.length,t.vertices=t.vertices.concat(e.EdgeGL.calculateVertices(i,s,o)),t.verticesNeedUpdate=!0,t.faces.push(new THREE.Face4(r,r+1,r+2,r+3,e.Common.NORMAL,n)),i.direction!==e.Edge.DIRECTION_NONE&&(t.faces.push(new THREE.Face3(r+4,r+5,r+6,e.Common.NORMAL,n)),i.direction===e.Edge.DIRECTION_BOTH&&t.faces.push(new THREE.Face3(r+7,r+8,r+9,e.Common.NORMAL,n)))},e.EdgeGL.DEFAULT_COLOR=new THREE.Color(0),e.EdgeGL.COLOR_POSITIVE=e.EdgeGL.DEFAULT_COLOR,e.EdgeGL.COLOR_NEGATIVE=new THREE.Color(8323072),e.EdgeGL.DEFAULT_MATERIAL=new THREE.MeshBasicMaterial({color:e.EdgeGL.DEFAULT_COLOR,opacity:.5}),e.EdgeGL.MATERIAL_FACECOLOR=new THREE.MeshBasicMaterial({shading:THREE.FlatShading,vertexColors:THREE.FaceColors}),e.GraphGL=function(t){this.graph=t,this.clickables=new THREE.Object3D,this.itemsGL=new e.HashMap},e.GraphGL.prototype.constructor=e.GraphGL,e.GraphGL.prototype.build=function(){var t,i;return t=this,i=new e.HashMap,this.graph.items.each(function(s,o){var r;r=i.get(o.id),r||(r=new e.GraphItemGL(o),i.put(o.id,r)),t.itemsGL.put(s,r)}),this},e.GraphGL.prototype.onCompress=function(t,i){var s,o,r,n,a,h,d,c,p,u,g,l,E;for(s=this,p=function(e){for(d=s.itemsGL.get(e),n=0,a=d.edges.length;a>n;n++)c=d.edges.pop(),c.removeFromScene(i);d.removeFromScene(i,s.clickables)},o=0,r=t.length;r>o;o++){for(h=t[o],u=h.idSet(),h.innerNodes.each(p),d=new e.GraphItemGL(h),n=0,a=u.length;a>n;n++)s.itemsGL.put(u[n],d);for(n=0,a=d.data.edges.length;a>n;n++)E=d.data.edges[n],g=this.itemsGL.get(E.sourceId),l=this.itemsGL.get(E.targetId),g.edgeReset(i),l.edgeReset(i);d.addToScene(i,this.clickables)}},e.GraphGL.prototype.onExpand=function(t,i){var s,o,r,n,a,h,d,c,p,u,g,l;for(s=this,n=this.itemsGL.get(t),n.removeFromScene(i,this.clickables),a=n.data,a.innerNodes.each(function(t,u){var g;for(n=new e.GraphItemGL(u),o=0,r=u.edges.length;r>o;o++)h=u.edges[o],a.hasNode(h.sourceId)&&a.hasNode(h.targetId)||(a.hasNode(h.sourceId)?(g=s.itemsGL.get(h.targetId),c=n.data.getNode(h.sourceId),p=g.data.getNode(h.targetId),d=new e.EdgeGL(h,c,p)):(g=s.itemsGL.get(h.sourceId),c=n.data.getNode(h.targetId),p=g.data.getNode(h.sourceId),d=new e.EdgeGL(h,p,c)),g.edgeReset(i,a),n.addEdgeGL(d),d.addToScene(i));s.itemsGL.put(t,n),n.addToScene(i,s.clickables)}),u=new e.HashMap,o=0,r=a.innerEdges.length;r>o;o++)h=a.innerEdges[o],g=h.sourceId+e.Common.SEPARATOR+h.targetId,l=h.targetId+e.Common.SEPARATOR+h.sourceId,u.get(g)!==!0&&(c=this.itemsGL.get(h.sourceId),p=this.itemsGL.get(h.targetId),d=new e.EdgeGL(h,c.data.getNode(h.sourceId),p.data.getNode(h.targetId)),c.addEdgeGL(d),p.addEdgeGL(d),d.addToScene(i)),u.put(g,!0),u.put(l,!0)},e.GraphGL.prototype.updateItem=function(t){var i,s,o,r,n,a;if(t instanceof e.Node)for(o=this.itemsGL.get(t.id),o.setPosition(t.x,t.y),i=0,s=o.edges.length;s>i;i++)r=o.edges[i],n=this.itemsGL.get(r.data.sourceId).data.getNode(r.data.sourceId),a=this.itemsGL.get(r.data.targetId).data.getNode(r.data.targetId),r.update(n,a)},e.GraphGL.prototype.removeFromScene=function(e){var t;t=this,this.itemsGL.each(function(i,s){var o,r,n;for(o=0,r=s.edges.length;r>o;o++)n=s.edges[o],n.removeFromScene(e);s.removeFromScene(e,t.clickables)})},e.Renderer=function(e){var t=this,i=-1e3,s=1e3,o=new THREE.AmbientLight(16777215);window.Stats&&(this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.right="0",this.stats.domElement.style.top="0",this.stats.domElement.style.zIndex="9999",document.body.appendChild(this.stats.domElement)),this.running=!1,this.config=e,this.graphGL=null,this.distance=1,this.active={nodeId:null,item:null},this.changed=!0,this.updateIterator=function(e,i){i.hasChanged()&&t.graphGL.updateItem(i)},this.$el=$(e.container).first(),this.el=this.$el.get(0),this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(this.width,this.height),this.scene=new THREE.Scene,this.projector=new THREE.Projector,this.camera=new THREE.OrthographicCamera(-this.width/2,this.width/2,this.height/2,-this.height/2,i,s),this.camera.lookAt(this.scene.position),this.camera.position.set(0,0,10),this.scene.add(this.camera),this.scene.add(o),this.$el.append(this.renderer.domElement)},e.Renderer.prototype.constructor=e.Renderer,e.Renderer.prototype.start=function(t){var i=this;this.graphGL&&(this.stats&&(document.body.removeChild(this.stats.domElement),delete this.stats),this.graphGL.removeFromScene(this.scene)),THREE.ImageUtils.loadTexture("media/chars.png",void 0,function(s){e.TextGenerator.getInstance().init(s),i.render(t)})},e.Renderer.prototype.render=function(t){var i,s,o;o=Math.round(Math.sqrt(t.getOrder())),s=new e.GraphMerger,this.graphMerged=s.edgeCollapse(o,t),this.graphGL=new e.GraphGL(this.graphMerged),this.scene.add(this.graphGL.clickables),this.graphGL.build(),i=this,this.graphGL.itemsGL.eachInstance("data.id",function(e,t){t.addToScene(i.scene,i.graphGL.clickables)}),this.changed=!0,this.running||(this.running=!0,this.update()),"function"==typeof this.loadCallback&&this.loadCallback.call(this)},e.Renderer.prototype.update=function(){this.stats&&this.stats.begin(),window.TWEEN&&TWEEN.update(),this.changed===!0&&(this.changed=!1,this.graphMerged.items.eachInstance("id",this.updateIterator)),this.renderer.render(this.scene,this.camera),this.stats&&this.stats.end(),window.requestAnimationFrame($.proxy(this.update,this))},e.Renderer.prototype.fit=function(){this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.updateCamera(),this.renderer.setSize(this.width,this.height)},e.Renderer.prototype.updateCamera=function(){var e,t;e=this.width/2*this.distance,t=this.height/2*this.distance,this.camera.left=-e,this.camera.right=e,this.camera.top=t,this.camera.bottom=-t,this.camera.updateProjectionMatrix()},e.Renderer.prototype.onUp=function(t,i){var s,o,r,n,a,h,d=[],c=[];if(this.active.item){if(i){for(n=this.active.item.getNode(this.active.nodeId),s=0,o=n.edges.length;o>s;s++)a=n.edges[s],a.sourceId!==n.id&&(h=this.graphGL.graph.getNode(a.sourceId),d.push(h),a.direction===e.Edge.DIRECTION_BOTH&&c.push(h)),a.targetId!==n.id&&(h=this.graphGL.graph.getNode(a.targetId),c.push(h),a.direction===e.Edge.DIRECTION_BOTH&&d.push(h));this.config.onSelect.apply(this,[n,d,c])}else this.graphGL.updateItem(this.active.item),r=this.graphMerged.compress(),this.graphGL.onCompress(r,this.scene),this.changed=!0;this.active.nodeId=null,this.active.item=null}},e.Renderer.prototype.onDown=function(e,t){var i,s,o,r,n,a,h;for(o=2*(t.x/this.width)-1,r=-(2*(t.y/this.height)-1),n=this.projector.pickingRay(new THREE.Vector3(o,r,-1),this.camera),a=n.intersectObjects(this.graphGL.clickables.children),i=0,s=a.length;s>i;i++)if(a[i].face.nodeId){h=a[i];break}h&&(this.active.nodeId=h.face.nodeId,this.active.item=this.graphMerged.items.get(this.active.nodeId))},e.Renderer.prototype.onMove=function(t,i){this.active.item?(this.active.item instanceof e.Cluster&&(this.graphMerged.expand(this.active.item),this.graphGL.onExpand(this.active.nodeId,this.scene),this.active.item=this.graphMerged.items.get(this.active.nodeId)),this.active.item.setPosition(this.active.item.x+i.x*this.distance,this.active.item.y-i.y*this.distance),this.changed=!0):(this.camera.position.x-=i.x*this.distance,this.camera.position.y+=i.y*this.distance)},e.Renderer.prototype.onZoom=function(e,t){var i,s;i=.05*t.delta,s=t.position,this.distance=Math.max(this.distance-i,.01),this.camera.position.x+=i*(s.x-this.width/2),this.camera.position.y-=i*(s.y-this.height/2),this.updateCamera()
},e.Renderer.prototype.focus=function(t,i,s){var o,r,n,a,h,d,c=this;o=this.graphGL.graph.getNode(t),o&&(r=this.el.offsetWidth,n=this.el.offsetHeight,a=Math.max(o.size/r,o.size/n),window.TWEEN&&TWEEN.removeAll(),s&&window.TWEEN?(d=this.camera.position.distanceTo(new THREE.Vector3(o.x,o.y,this.camera.position.z)),h=e.Renderer.ANIMATION_SLOWDOWN*d,h=Math.min(Math.max(h,1e3),3e3),new TWEEN.Tween(this.camera.position).to({x:o.x,y:o.y},h).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){c.updateCamera()}).start(),i&&new TWEEN.Tween(this).to({distance:20*a+d/1e3},h/2).easing(TWEEN.Easing.Quadratic.InOut).chain(new TWEEN.Tween(this).to({distance:20*a},h/2).easing(TWEEN.Easing.Quadratic.InOut)).start()):(this.camera.position.x=o.x,this.camera.position.y=o.y,i&&(this.distance=20*a),this.updateCamera()))},e.Renderer.ANIMATION_SLOWDOWN=2,e.MouseInput=function(e){this.$el=$(e.container).first(),this.state={isDown:!1,wasMoved:!1,downX:0,downY:0,lastX:0,lastY:0},this.register()},e.MouseInput.prototype.constructor=e.MouseInput,e.MouseInput.prototype.register=function(){this.$el.mouseup($.proxy(this.onMouseUp,this)),this.$el.mousemove($.proxy(this.onMouseMove,this)),this.$el.mousedown($.proxy(this.onMouseDown,this)),this.$el.mousewheel($.proxy(this.onMouseScroll,this))},e.MouseInput.prototype.onMouseUp=function(){var t;this.state.isDown=!1,t=!this.state.wasMoved,this.state.wasMoved=!1,$(this).trigger(e.MouseInput.EVENT_UP,t)},e.MouseInput.prototype.onMouseMove=function(t){var i,s,o,r;this.state.isDown===!0&&(s=this.calcPosition(t),o=Math.abs(this.state.downX-s.x),r=Math.abs(this.state.downY-s.y),o+r>e.MouseInput.PIXEL_GLUE&&(this.state.wasMoved=!0,i={origX:this.state.lastX,origY:this.state.lastY,x:s.x-this.state.lastX,y:s.y-this.state.lastY},this.state.lastX=s.x,this.state.lastY=s.y,$(this).trigger(e.MouseInput.EVENT_MOVE,i)))},e.MouseInput.prototype.onMouseDown=function(t){var i;return i=this.calcPosition(t),this.state.downX=i.x,this.state.downY=i.y,this.state.lastX=i.x,this.state.lastY=i.y,this.state.isDown=!0,$(this).trigger(e.MouseInput.EVENT_DOWN,i),!1},e.MouseInput.prototype.onMouseScroll=function(t,i,s,o){var r;t.preventDefault(),(0>o||o>0)&&(r=this.calcPosition(t.originalEvent),$(this).trigger(e.MouseInput.EVENT_SCROLL,{delta:o,position:r}))},e.MouseInput.prototype.calcPosition=function(e){return{x:Math.floor(e.clientX-this.$el.offset().left),y:Math.floor(e.clientY-this.$el.offset().top)}},e.MouseInput.EVENT_UP="gx.MouseInput.EVENT_UP",e.MouseInput.EVENT_DOWN="gx.MouseInput.EVENT_DOWN",e.MouseInput.EVENT_MOVE="gx.MouseInput.EVENT_MOVE",e.MouseInput.EVENT_SCROLL="gx.MouseInput.EVENT_SCROLL",e.MouseInput.PIXEL_GLUE=2,window.grax=window.grax||function(){var t,i,s,o;return o=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return!1}},{init:function(s){o()?(s.onSelect=s.onSelect||function(){},t=new e.Renderer(s),i=new e.MouseInput(s),$(i).bind(e.MouseInput.EVENT_UP,$.proxy(t.onUp,t)),$(i).bind(e.MouseInput.EVENT_DOWN,$.proxy(t.onDown,t)),$(i).bind(e.MouseInput.EVENT_MOVE,$.proxy(t.onMove,t)),$(i).bind(e.MouseInput.EVENT_SCROLL,$.proxy(t.onZoom,t))):$(s.container).html('<p class="noWebGL">Your browser does not support WebGL. Please see <a href="http://get.webgl.org/">get.webgl.org</a> for details.</p>')},fit:function(){t&&t.fit()},find:function(e){return e&&e.length>0?s.find(e):null},focus:function(e,i,s){t.focus(e,i,s)},ego:function(i,o,r,n){var a,h,d=new e.EgoNetwork,c=t.graphGL.graph.clone();a=d.create(i,o,n,c),r&&(h=new e.ForceLayout(a),a=h.run(),this.focus(n[0])),s=new e.NodeSearch(a),t.start(a)},layout:function(i){var s,o;100>t.graphGL.graph.getOrder()&&(s=t.graphGL.graph.clone(),s.fullExpand(),o=new e.ForceLayout(s),s=o.run(i),this.focus(s.items.keySet()[0]),t.start(s))},load:function(i,o){var r;t.loadCallback=o,r=new e.Processor(t,i),r.start(function(i){var o,r;o=new e.GraphMLParser,r=o.parse(i),s=new e.NodeSearch(r),t.start(r)})}}}()})();