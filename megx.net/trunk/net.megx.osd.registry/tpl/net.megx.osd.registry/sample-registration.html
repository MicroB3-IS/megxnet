<link
  href="$ctx.siteUrl/net.megx.osd.registry/stylesheets/osdRegistry.css"
  rel="stylesheet" type="text/css"
>
<link
  href="$ctx.siteUrl/net.megx.osd.registry/stylesheets/alpaca-1.1.3.css"
  rel="stylesheet" type="text/css"
>
<link
  href="$ctx.siteUrl/net.megx.osd.registry/stylesheets/alpaca-jqueryui-1.1.3.min.css"
  rel="stylesheet" type="text/css"
>
<script type="text/javascript"
  src="$ctx.siteUrl/net.megx.osd.registry/js/osdRegistry.js"
></script>


<script type="text/javascript"
  src="https://dl.dropboxusercontent.com/u/1611524/gcdj_widget/gcdj-osd-widget/js/jquery-1.10.2.js"
></script>
<script type="text/javascript"
  src="https://dl.dropboxusercontent.com/u/1611524/gcdj_widget/gcdj-osd-widget/js/jquery.tmpl-1.0.0pre.js"
></script>
<!-- jQuery UI Support -->
<script type="text/javascript"
  src="https://dl.dropboxusercontent.com/u/1611524/gcdj_widget/gcdj-osd-widget/js/jquery-ui-1.10.4.custom.min.js"
></script>
<!-- Alpaca -->
<script type="text/javascript"
  src="$ctx.siteUrl/net.megx.osd.registry/js/alpaca-full-1.1.3.js"
></script>

    <script type="text/javascript"
          src="http://alpacajs.org/lib/jquery-ui-timepicker-addon/jquery-ui-timepicker-addon.js"></script>

<style id="jsbin-css">


.mx-env-param {
  
  background-color: green
}
.mx-site {
  
  background-color: blue 
}

.mx-sample {
  
  background-color: orange
}

</style>
</head>
<body>

  <h1>Register your OSD sample(s)</h1>
  <div style="padding: 20px 20px 20px 20px">
    <p>On this page you will be able to register your OSD summer
      solstice 2014 sample(s) from June 20, 2014 on.</p>
  </div>
  <h3>The web form</h3>
  <div style="padding: 20px 20px 20px 20px">
    <p>We want you to give you an impression about what little it
      takes to register an OSD 2014 sample for sequencing, bioarchiving,
      and data deposition. Therefore below, you see the current status
      of the sample registration form we are preparing for you.
      Please note, that web form is currently under heavy development
      and will be ready soon for you.</p>

    <p>
      Please have a look and <a href="mailto:megx@mpi-bremen.de"> if
        you have questions and feedback we would be more than happy if
        you contact us.</a>
    </p>
  </div>
  <div id="osd-sample-form"></div>
  <script>
      /********   CONFIGURATION  ********/

      var targetContainerId = "osd-sample-form";
      var checkListFormAction = "TheAction";

      var schemaLocation = "https://dl.dropboxusercontent.com/u/1611524/gcdj_widget/gcdj-osd-widget/js/data/osd_schema.json";
      var optionsLocation = "https://dl.dropboxusercontent.com/u/1611524/gcdj_widget/gcdj-osd-widget/js/data/osd_options.json";

      // add extra validation if you like
      function submitCheckListForm( form ) {
        return true;
      }

      /********   END CONFIGURATION  *****/
var inputBundle = {
    "optionsSource": optionsLocation,
    "schemaSource": schemaLocation,
    //create means no inital validation
    "view": "VIEW_JQUERYUI_CREATE",
    "isDynamicCreation": true, 
 "postRender": function (field) {
        var form = field.form;

        var pangaeaCSV = function (doc) {
            var delim = "\t";
            var pig_val = null;
            var flowcyto_val = null;
            var ph_val = null;
            var env = doc.environment;

            var header = "lat\tlon\tdepth\tdate_time\ttemperature\tsalinity\tchlorophyll\tflow-cytometrie\tph";


            if (env.pigment_concentration.hasOwnProperty('measurement')) {
                pig_val = doc.environment.pigment_concentration.measurement.value;
            }
            if (env.picoplankton_flow_cytometry.hasOwnProperty('measurement')) {
                flowcyto_val = JSON.stringify(env.picoplankton_flow_cytometry.measurement);

            }
            if (env.ph.hasOwnProperty('measurement')) {

                ph_val = env.ph.measurement.value;
            }

            return header + "\n" + doc.sampling_site.latitude + delim + doc.sampling_site.longitude + delim + doc.sample.depth + delim + doc.sample.date_time + delim + doc.environment.temperature + delim + doc.environment.salinity + delim + pig_val + delim + flowcyto_val + delim + ph_val;
        };


        if (form) {
            form.refreshValidationState(false);
            form.registerSubmitHandler(function (e, form) {
                // validate the entire form (top control + all children)
                form.validate(true);
                // draw the validation state (top control + all children)   
                form.refreshValidationState(true);
                // now display something 
                if (form.isFormValid()) {

                    var json = form.getValue();
                    console.log("json=" + JSON.stringify(json));
                    alert("test");
                    alert("The form looks good! \n\n" + "Pangaea Data\n\n" + pangaeaCSV(json) + "\n\nPlease copy and save text before closing  this dialog for submission");
                } else {
                    alert("There are problems with the form.  Please make the any necessary corrections.");
                }
                e.stopPropagation();
                return false;
            });
        }

    }
}; 


      function renderForm() {
        $("#" + targetContainerId).alpaca(inputBundle);
      }

      $(document).ready(function() {
        Alpaca.defaultUI = "jquery-ui";
        Alpaca.logLevel = Alpaca.ERROR;
        renderForm();
      });
    </script>
</body>
</html>
